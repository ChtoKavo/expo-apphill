# 📊 ВИЗУАЛЬНАЯ СХЕМА РАБОТЫ PUSH-УВЕДОМЛЕНИЙ

---

## 🔄 ПОЛНЫЙ ЦИКЛ ОТПРАВКИ СООБЩЕНИЯ

```
┌─────────────────────────────────────────────────────────────────────┐
│ СЦЕНАРИЙ: Юзер A отправляет сообщение юзеру B (B ОФЛАЙН)          │
└─────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────┐
│ 1️⃣ КЛИЕНТ A (ОТПРАВИТЕЛЬ)                                           │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  📱 Юзер A открывает чат и пишет: "Привет!"                        │
│                  ↓                                                   │
│  📤 Отправляет POST /api/messages                                   │
│  {                                                                   │
│    receiver_id: 456 (Юзер B),                                       │
│    message: "Привет!",                                              │
│    ...                                                               │
│  }                                                                   │
│                  ↓                                                   │
│  📍 Устанавливает set_active_chat (он в чате сейчас)                │
│                  ↓                                                   │
│  🔌 Отправляет событие через Socket.IO: 'new_message'              │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────────┐
│ 2️⃣ СЕРВЕР (ОБРАБОТКА)                                               │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  📥 Получил POST /api/messages от юзера 123                         │
│       ↓                                                              │
│  💾 Сохранил сообщение в БД:                                        │
│     INSERT INTO messages (sender_id, receiver_id, message, ...)    │
│       ↓                                                              │
│  🔌 Отправил Socket.IO событие 'new_message' в комнату user_456   │
│     (если B онлайн - получит сразу через Socket)                   │
│       ↓                                                              │
│  📱 PUSH-УВЕДОМЛЕНИЕ (НОВОЕ ИСПРАВЛЕННОЕ ПОВЕДЕНИЕ):               │
│     ┌─────────────────────────────────────────────────────────────┐│
│     │ ⭐ ВСЕГДА отправляем push, независимо от состояния!          ││
│     └─────────────────────────────────────────────────────────────┘│
│       ↓                                                              │
│  🔍 Получаем push-токен юзера 456 из БД:                           │
│     SELECT push_token FROM push_tokens                              │
│     WHERE user_id = 456                                             │
│     → ExponentPushToken[...]                                        │
│       ↓                                                              │
│  ✅ Отправляем push в Expo API:                                     │
│     expo.sendPushNotificationsAsync([{                              │
│       to: 'ExponentPushToken[...]',                                 │
│       title: '📨 Alice',                                            │
│       body: 'Привет!',                                              │
│       data: { type: 'new_message', ... }                            │
│     }])                                                              │
│       ↓                                                              │
│  📊 Лог сервера:                                                    │
│     ======================================================================│
│     📱 PUSH-УВЕДОМЛЕНИЕ: Личное сообщение                          │
│        Получатель: 456                                              │
│        От: Alice (123)                                              │
│     ======================================================================│
│     ✅ Push успешно отправлен                                       │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────────┐
│ 3️⃣ EXPO (ДОСТАВКА)                                                  │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ☁️ Expo получил push уведомление                                    │
│       ↓                                                              │
│  📡 Отправляет через Google FCM на устройство B                     │
│       ↓                                                              │
│  ✅ Устройство B получило push (даже если приложение закрыто!)       │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘
                              ↓
┌──────────────────────────────────────────────────────────────────────┐
│ 4️⃣ КЛИЕНТ B (ПОЛУЧАТЕЛЬ - ПРИЛОЖЕНИЕ ЗАКРЫТО)                      │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  📱 Устройство B получило push от Expo                              │
│       ↓                                                              │
│  📞 Звуковой сигнал + вибрация                                      │
│  [Уведомление на экране блокировки]                                 │
│  ┌─────────────────────────────────┐                                │
│  │ 📨 Alice                         │                               │
│  │ Привет!                          │                               │
│  └─────────────────────────────────┘                                │
│       ↓ (пользователь нажимает на уведомление)                      │
│  🚀 Приложение открывается                                          │
│       ↓                                                              │
│  📨 Открывается чат с Alice                                         │
│       ↓                                                              │
│  💬 Сообщение видно в чате!                                         │
│                                                                      │
│  📊 Лог клиента:                                                     │
│     ======================================================================│
│     🔔 PUSH-УВЕДОМЛЕНИЕ ПОЛУЧЕНО                                    │
│        Тип: new_message                                             │
│        От: 123                                                      │
│        Текущий юзер: 456                                            │
│        Активный чат: null                                           │
│     ======================================================================│
│     ✅ Показываем push-уведомление                                   │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘

✅ РЕЗУЛЬТАТ: B получил push и прочитал сообщение!
```

---

## 🔄 ДРУГОЙ СЦЕНАРИЙ: B ОНЛАЙН И В ЧАТЕ

```
┌──────────────────────────────────────────────────────────────────────┐
│ СЦЕНАРИЙ: Юзер B ОНЛАЙН и НАХОДИТСЯ В ЧАТЕ с A                    │
└──────────────────────────────────────────────────────────────────────┘

Шаги 1-3 идентичны (сообщение отправляется, push отправляется)

┌──────────────────────────────────────────────────────────────────────┐
│ 4️⃣ КЛИЕНТ B (ПОЛУЧАТЕЛЬ - ПРИЛОЖЕНИЕ ОТКРЫТО, В ЧАТЕ)              │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  📬 Одновременно получает push И Socket.IO событие                  │
│       ↓                                                              │
│  🔌 Socket.IO событие 'new_message' прибывает первым                │
│       ↓                                                              │
│  💬 Сообщение сразу видно в чате!                                   │
│       ↓                                                              │
│  🔔 Нотификационный обработчик получает push                        │
│  console.log('PUSH получен')                                        │
│       ↓                                                              │
│  🧠 ЛОГИКА (Исправленная версия):                                   │
│  ┌─────────────────────────────────────────────────────────────────┐│
│  │ if (activeChat.chatId === sender_id &&                          ││
│  │     activeChat.chatType === 'personal') {                       ││
│  │   // ⭐ Пользователь в этом чате!                              ││
│  │   // ✅ НЕ показываем локальное уведомление (вредно)           ││
│  │   return {                                                      ││
│  │     shouldShowAlert: false,   // НЕ показывать                 ││
│  │     shouldPlaySound: false,   // НЕ звучать                    ││
│  │     shouldSetBadge: false,    // НЕ менять badge               ││
│  │   };                                                            ││
│  │ }                                                               ││
│  └─────────────────────────────────────────────────────────────────┘│
│       ↓                                                              │
│  📊 Лог клиента:                                                     │
│     ======================================================================│
│     🔔 PUSH-УВЕДОМЛЕНИЕ ПОЛУЧЕНО                                    │
│        Тип: new_message                                             │
│        От: 123                                                      │
│        Текущий юзер: 456                                            │
│        Активный чат: 123 (personal)  ← КЛЮЧЕВОЙ МОМЕНТ!             │
│     ======================================================================│
│     ⚠️ Пользователь внутри чата - уведомление скрыто               │
│                                                                      │
└──────────────────────────────────────────────────────────────────────┘

✅ РЕЗУЛЬТАТ: B видит сообщение в чате, не получает дубль уведомления!
```

---

## 📋 ТАБЛИЦА РЕШЕНИЙ ПО СОСТОЯНИЯМ

```
╔════════════════════╦═══════════════╦══════════════╦════════════════╗
║ СОСТОЯНИЕ B        ║ Socket.IO     ║ Push         ║ Результат      ║
║                    ║ Событие       ║ Уведомление  ║                ║
╠════════════════════╬═══════════════╬══════════════╬════════════════╣
║                    ║               ║              ║                ║
║ 1. Онлайн в чате   ║ ✅ Приходит   ║ ❌ Скрывается║ Видит сразу в  ║
║    (приложение     ║    сразу      ║    (логика)  ║ чате, без      ║
║    открыто)        ║               ║              ║ дубля          ║
║                    ║               ║              ║                ║
╠════════════════════╬═══════════════╬══════════════╬════════════════╣
║                    ║               ║              ║                ║
║ 2. Онлайн но вне   ║ ✅ Приходит   ║ ✅ Показ.   ║ Видит в чате + ║
║    чата (другой    ║    (другая    ║    (другой   ║ получает push  ║
║    экран)          ║    комната)   ║    чат)      ║                ║
║                    ║               ║              ║                ║
╠════════════════════╬═══════════════╬══════════════╬════════════════╣
║                    ║               ║              ║                ║
║ 3. Офлайн          ║ ❌ НЕ приход. ║ ✅ Показ.   ║ Получает push, ║
║ (приложение        ║    (нет       ║    (есть     ║ видит при      ║
║ закрыто)           ║    socket)    ║    токен)    ║ открытии       ║
║                    ║               ║              ║                ║
╚════════════════════╩═══════════════╩══════════════╩════════════════╝
```

---

## 🔀 ФИЛЬТРАЦИЯ: КОГДА ОТПРАВЛЯЕМ PUSH

```
┌─────────────────────────────────────────────────────────────┐
│ ГРУППОВОЕ СООБЩЕНИЕ: Кому отправляем push?                │
└─────────────────────────────────────────────────────────────┘

Группа: "JavaScript Dev Team"
Участники:
├─ Alice (отправитель)
├─ Bob (онлайн, в чате группы)
├─ Charlie (онлайн, но вне этого чата)
└─ Diana (офлайн)

╔════════════════╦═════════════════════════════════════════════╗
║ Участник       ║ Push отправляем?                           ║
╠════════════════╬═════════════════════════════════════════════╣
║                ║                                             ║
║ Alice          ║ ❌ НЕТ (отправитель = не отправляем себе)  ║
║                ║                                             ║
╠════════════════╬═════════════════════════════════════════════╣
║                ║                                             ║
║ Bob            ║ ❌ НЕТ (в активном чате = не нужен push)   ║
║                ║     Socket.IO доставит сразу через чат    ║
║                ║                                             ║
╠════════════════╬═════════════════════════════════════════════╣
║                ║                                             ║
║ Charlie        ║ ✅ ДА (вне чата = нужно уведомить)        ║
║                ║     Socket.IO НЕ доставит сообщение       ║
║                ║                                             ║
╠════════════════╬═════════════════════════════════════════════╣
║                ║                                             ║
║ Diana          ║ ✅ ДА (офлайн = обязательно нужен push)    ║
║                ║     Socket.IO НЕ может доставить          ║
║                ║                                             ║
╚════════════════╩═════════════════════════════════════════════╝

ИТОГО PUSH ОТПРАВЛЯЕМ: Charlie + Diana (2 человека)
```

---

## 🔧 ТЕХНИЧЕСКИЙ ПОТОК

```
┌──────────────────────────────────────────────────────────────┐
│ КОД ОТПРАВИТЕЛЯ (Expo Client)                               │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  const sendMessage = async (message) => {                    │
│    // 1️⃣ Установить что пользователь в этом чате             │
│    setActiveChatContext(recipientId, 'personal');            │
│       ↓                                                       │
│    // 2️⃣ Отправить на сервер                                 │
│    await api.post('/api/messages', {                         │
│      receiver_id: recipientId,                               │
│      message: message                                        │
│    });                                                        │
│       ↓                                                       │
│    // 3️⃣ Socket.IO событие отправляется автоматически        │
│  }                                                            │
│                                                              │
│  // 4️⃣ При выходе из чата                                    │
│  useEffect(() => {                                           │
│    return () => {                                            │
│      clearActiveChatContext();  // Сказать серверу          │
│    };                                                        │
│  }, []);                                                      │
│                                                              │
└──────────────────────────────────────────────────────────────┘
                           ↓↓↓
┌──────────────────────────────────────────────────────────────┐
│ КОД СЕРВЕРА (Node.js)                                       │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  app.post('/api/messages', authenticateToken, (req, res) => {
│    // 1️⃣ Сохранить сообщение в БД                           │
│    const messageId = await saveMessageToDB(...);             │
│       ↓                                                       │
│    // 2️⃣ Отправить Socket.IO                                │
│    io.to(`user_${receiver_id}`).emit('new_message', {...});  │
│       ↓                                                       │
│    // 3️⃣ ВСЕГДА отправляем push (Исправление!)              │
│    (async () => {                                            │
│      // Получить токен                                       │
│      const token = await getPushTokenFromDB(receiver_id);    │
│      if (!token) return;  // Только если токена нет          │
│       ↓                                                       │
│      // Отправить в Expo                                     │
│      const result = await expo.sendPushNotificationsAsync([{ │
│        to: token,                                            │
│        title: `📨 ${sender_name}`,                           │
│        body: message,                                        │
│        data: { type: 'new_message', ... }                    │
│      }]);                                                    │
│    })();                                                     │
│       ↓                                                       │
│    res.json({ success: true, messageId });                   │
│  });                                                          │
│                                                              │
│  // 4️⃣ Синхронизация активного чата                         │
│  socket.on('set_active_chat', (data) => {                    │
│    activeChats.set(userId, {                                │
│      chatId: data.chat_id,                                   │
│      chatType: data.chat_type                                │
│    });                                                       │
│  });                                                          │
│                                                              │
│  socket.on('clear_active_chat', () => {                      │
│    activeChats.delete(userId);                               │
│  });                                                          │
│                                                              │
└──────────────────────────────────────────────────────────────┘
```

---

## ✅ КОНТРОЛЬНАЯ ТОЧКА: ЧТО ДОЛЖНО БЫТЬ

```
┌────────────────────────────────────────────────────────────┐
│ КЛИЕНТ (Expo)                                             │
├────────────────────────────────────────────────────────────┤
│                                                            │
│ ✅ Функция: registerForPushNotificationsAsync()           │
│ ✅ Функция: setActiveChatContext()                         │
│ ✅ Функция: clearActiveChatContext()                       │
│ ✅ Функция: Notifications.setNotificationHandler()         │
│ ✅ Socket события: set_active_chat / clear_active_chat     │
│                                                            │
│ Файлы:                                                    │
│ ✅ notifications.js - с логированием                      │
│ ✅ ChatScreen.js - с set_active_chat/clear_active_chat    │
│                                                            │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│ СЕРВЕР (Node.js)                                          │
├────────────────────────────────────────────────────────────┤
│                                                            │
│ ✅ Функция: getPushTokenFromDB(userId)                    │
│ ✅ Функция: isUserInActiveChat(userId, chatId, type)      │
│ ✅ Переменная: const expo = new Expo()                    │
│ ✅ Map: const activeChats = new Map()                     │
│                                                            │
│ Socket слушатели:                                        │
│ ✅ socket.on('set_active_chat', ...)                      │
│ ✅ socket.on('clear_active_chat', ...)                    │
│                                                            │
│ Эндпоинты:                                                │
│ ⏳ POST /api/messages - исправить push логику             │
│ ⏳ POST /api/groups/:groupId/messages - исправить фильтр  │
│                                                            │
│ Таблицы БД:                                               │
│ ✅ push_tokens (user_id, push_token, device_type, ...)    │
│ ✅ messages (sender_id, receiver_id, message, ...)        │
│                                                            │
└────────────────────────────────────────────────────────────┘

┌────────────────────────────────────────────────────────────┐
│ ИНФРАСТРУКТУРА                                            │
├────────────────────────────────────────────────────────────┤
│                                                            │
│ ✅ Node.js сервер работает                                │
│ ✅ MySQL БД с таблицей push_tokens                        │
│ ✅ Socket.IO настроен                                     │
│ ✅ Expo SDK подключен (expo.sendPushNotificationsAsync)   │
│ ✅ Доступ в интернет для Expo API                         │
│                                                            │
└────────────────────────────────────────────────────────────┘
```

---

## 🧠 ЛОГИКА ВЫБОРА: ОТПРАВЛЯТЬ ЛИ PUSH?

```
ЛИЧНОЕ СООБЩЕНИЕ:

  Получили сообщение?
         ↓ ДА
  Есть токен у получателя в БД?
         ↓ ДА → Отправляем в Expo!
         ↓ НЕТ → Пропускаем (нет куда отправлять)

ГРУППОВОЕ СООБЩЕНИЕ:

  Для каждого члена группы:
         ↓
  Это отправитель? → ДА: Пропускаем (не отправляем себе)
         ↓ НЕТ
  Находится в активном чате? → ДА: Пропускаем (Socket.IO доставит)
         ↓ НЕТ
  Есть токен? → ДА: Отправляем в Expo!
         ↓ НЕТ → Пропускаем

ВХОДЯЩИЙ ВЫЗОВ:

  Получен запрос вызова?
         ↓ ДА
  Есть токен у получателя?
         ↓ ДА → Отправляем в Expo!
         ↓ НЕТ → Пропускаем
```

---

**Эта диаграмма помогает визуально понять как все работает вместе! 📊✨**
